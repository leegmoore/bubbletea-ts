# Decision Log
Capture durable architectural/process choices. Use the table below for quick reference; elaborate beneath if necessary.

| ID | Date | Title | Decision | Status |
| --- | --- | --- | --- | --- |
| D-001 | 2025-11-14 | Target runtime/tooling | Port will target Node.js ≥ 20.11, TypeScript 5.x, ESM-first output bundled with tsup; pnpm chosen for workspace management. | Final |
| D-002 | 2025-11-14 | Tests-first methodology | All Go tests will be translated to Vitest suites _before_ implementing corresponding production code; session workflow enforces writing/porting tests first. | Final |
| D-003 | 2025-11-14 | Session ritual & logging | Every session must read `.port-plan/plan.md`, `progress-log.md`, `decision-log.md`, then update progress + decision logs before ending, ensuring stateless restarts. | Final |
| D-004 | 2025-11-14 | Cmd async contract | TypeScript `Cmd` functions may return a message synchronously or via `Promise`, enabling timer-backed commands to match Go semantics while remaining non-blocking. | Final |
| D-005 | 2025-11-14 | Timer scheduling semantics | `Tick` and `Every` spin up timers upon command creation and resolve via promises so they stay aligned with the system clock and remain compatible with fake timers. | Final |
| D-006 | 2025-11-14 | Program scaffold & options | Introduced a `Program` class with `StartupOptions` bitset, Node stream defaults, and option helpers (`WithOutput`, `WithMouse*`, etc.) that mirror Go semantics while remaining test-friendly via pure functions. | Final |
| D-007 | 2025-11-14 | Runtime error taxonomy | Mirror Go’s `ErrProgramKilled`/`ErrProgramPanic` as dedicated `ProgramKilledError`/`ProgramPanicError` subclasses so tests and consumers can rely on idiomatic `instanceof` checks during runtime failures. | Final |
| D-008 | 2025-11-14 | Program runtime architecture | Adopted a single-threaded state-machine event loop in `packages/tea/src/index.ts` with an async message queue, filter-first dispatch, key-input synthesis, and AbortController-driven shutdown so Go lifecycle semantics (quit/kill/panic propagation) are preserved under Node’s event loop. | Final |
| D-009 | 2025-11-14 | Renderer flushing strategy | `StandardRenderer` now buffers frames and flushes them via a ticker (matching Go’s FPS throttling) while exposing the full renderer interface so alt-screen, mouse, focus, and cleanup sequences can be driven by the translated tests. | Final |
| D-010 | 2025-11-14 | Logging adapter strategy | `LogToFile` configures a console-backed adapter that normalizes prefixes and rebinds `console.*` to a file-backed stream, mirroring Go’s `log.Default()` so translated logging tests reflect real runtime behavior. | Final |
| D-011 | 2025-11-14 | Renderer spec dependency | StandardRenderer work (tests + runtime) stays blocked until the upstream Go suite (`renderer_test.go`) is available; no production tweaks will ship without that spec. | Superseded (see D-012) |
| D-012 | 2025-11-14 | Renderer spec synthesis | Because no StandardRenderer tests exist anywhere in the upstream history, we will author a Go renderer spec ourselves and treat it as the canonical reference before porting the suite to TypeScript. | Final |
| D-013 | 2025-11-14 | Renderer print-line contract | Introduced a canonical `bubbletea/print-line` message (driven by `Println`/`Printf`) plus queued flush semantics in `StandardRenderer`, guaranteeing print output renders before the next frame just as in Go. | Final |
| D-014 | 2025-11-14 | Scroll-area helper parity | Ported ignored-line tracking plus `SyncScrollArea`/`ScrollUp`/`ScrollDown` commands to TypeScript, emitting the same ANSI margin/insert sequences as Go so high-performance rendering hooks stay usable. | Final |
| D-015 | 2025-11-14 | Printf formatting strategy | Replaced `util.format` with a custom Go-like formatter that honors Go’s flags/width/precision so `tea.Printf` messages match `fmt.Sprintf` semantics before hitting the renderer queue. | Final |
| D-016 | 2025-11-14 | Printf zero-flag parity | Integer verbs now treat the zero flag as implicit precision (mirroring Go’s `%#08x` behaviour) and float verbs retain zero-padding even when precisions are set, ensuring formatter output matches `fmt.Sprintf`. | Final |
| D-017 | 2025-11-14 | Startup toggle enforcement | Program now applies `StartupFlag` toggles (alt screen, bracketed paste opt-outs, mouse SGR modes, focus reporting) immediately after `renderer.start()` and exposes `Enable/DisableReportFocus` commands to maintain Go parity. | Final |
| D-018 | 2025-11-14 | Logging fan-out helper | Introduced `FanOutWritable` plus `createMultiWriterLogOptions` so `LogToFile` can mirror Go’s `io.MultiWriter`, allowing console/file logs to fan out to arbitrary writable streams (structured loggers, stderr mirrors, etc.). | Final |
| D-019 | 2025-11-14 | Console patch lifecycle | `ConsoleLogOptions` now reference-counts active outputs and restores the original `console` methods automatically once all log streams close, scoping logging side effects to each `LogToFile` session. | Final |
| D-047 | 2025-11-14 | Windows binding loader strategy | Windows builds will resolve `WindowsConsoleBinding` through a lazy loader that prefers a Node-API addon (`@bubbletea/windows-binding`), honors env-path overrides, offers an opt-in `ffi-napi` fallback, caches the first successful instance, and still allows `setWindowsConsoleBindingForTests` overrides; fatal resolution failures throw a `BubbleTeaWindowsBindingError` with remediation guidance. | Proposed |
| D-020 | 2025-11-14 | Windows console release capture | Capture the Windows console mode before VT flags flip so `releaseTerminal()` restores the true pre-program state while mouse tracking remains opt-in after `restoreTerminal()`. | Final |
| D-020 | 2025-11-14 | Windows console mode management | The TypeScript runtime now mirrors Go’s `prepareConsole` by flipping `ENABLE_WINDOW_INPUT`/`ENABLE_EXTENDED_FLAGS` on Windows TTY handles, toggling `ENABLE_MOUSE_INPUT` whenever `EnableMouse*`/`DisableMouse` run, and restoring the original mode during `releaseTerminal()`/program shutdown via the binding. | Final |
| D-020 | 2025-11-14 | Windows console input translation | Windows pseudo-console key/mouse/window records are routed through the new TypeScript helpers and Program-level mouse tracking so models receive the same `KeyMsg`/`MouseMsg` semantics defined in `inputreader_windows.go` before production code changes land. | Final |
| D-020 | 2025-11-14 | Windows resize watcher strategy | Windows `WindowSizeMsg` delivery now flows through the console binding’s pseudo-console input stream (window-buffer-size records) instead of Unix signal hooks, so both tests and runtime share a single cross-platform contract. | Final |
| D-020 | 2025-11-14 | Windows console binding contract | Expanded the Windows console binding to expose input-record streaming, cancelation, and pseudo-console creation/resizing so Windows-specific tests can drive behaviour via the fake harness before a native binding exists. | Final |
| D-045 | 2025-11-14 | TTY fallback & Windows VT hooks | `Program` resolves inputs via a dedicated `openInputTTY` helper—opening a fresh TTY whenever the default stream isn’t a terminal or `WithInputTTY` is set—and wires Windows VT enablement through internal hook functions so specs can exercise both Unix and Win32 paths before the real console bindings land. | Final |
| D-020 | 2025-11-14 | Input reader lifecycle | `Program` now owns the `createCancelableInputReader` instance, cancelling and closing it during shutdown so stdin/custom streams consistently emit `InputReaderCanceledError` (parity with Go’s `ReleaseTerminal`). | Final |
| D-020 | 2025-11-14 | Printf rich/unicode formatting | Added structured `%#v` helpers that emit Go-style slice/object literals and a `%U`/`%#U` formatter that outputs `U+` code points (optionally with printable runes) before renderer dispatch. | Final |
| D-021 | 2025-11-14 | Structured logging parity | Codified append-only log file semantics plus stderr-style fan-out via new Go/Vitest suites, ensuring `LogToFile` stays multi-process safe and extra writable targets (e.g., Windows `stderr`) are never closed by the adapter. | Final |
| D-022 | 2025-11-14 | Go-style formatter metadata | Introduced shared `Symbol.for('bubbletea.goType')`/`Symbol.for('bubbletea.goPointer')` markers so `%#v` and pointer formatting can honor Go type names and address semantics within the TS runtime/tests. | Final |
| D-023 | 2025-11-14 | Windows validation harness | Adopted `FakeWindowsTerminal` + `WindowsWritable` plus dedicated Go/Vitest suites to canonically capture Windows-specific renderer/logging behaviour before adjusting runtime code. | Final |
| D-024 | 2025-11-14 | Cross-platform CI coverage | Added `.github/workflows/ci.yml` to run `pnpm test` and `go test ./...` on Ubuntu and Windows runners so Windows-only specs execute on every push/PR. | Final |
| D-025 | 2025-11-14 | Windows newline normalization | StandardRenderer writes and logging fan-out targets now normalize `\r\n` sequences whenever `process.platform === 'win32'`, keeping terminal mirrors CRLF-safe without mutating file outputs. | Final |
| D-026 | 2025-11-14 | TS docs & examples location | Established `docs/` for renderer/logging guides plus `examples-ts/` scripts (mirroring the Vitest harnesses) so Windows CRLF + fan-out guarantees are documented and reproducible outside the tests. | Final |
| D-027 | 2025-11-14 | Map formatter key ordering | `%#v` map formatting now sorts entries via a Go-like, type-aware comparator so nested maps/struct tags emit the same order as Go’s `fmtsort` before flushing to the renderer. | Final |
| D-028 | 2025-11-14 | Numeric map type inference | Mixed int/float map key sets are inferred as `float64` so `%#v` output stays aligned with Go’s `fmtsort` when NaN/±Inf + integral keys share the same map. | Final |
| D-029 | 2025-11-14 | Declared-vs-interface map ordering | `%#v` map formatting now ranks keys by the declared map key type (preserving float NaN ordering) and only falls back to each key’s dynamic Go type when the map is keyed by `interface{}`; interface types render with the Go-style space (`interface {}`) to mirror `fmt`. | Final |
| D-030 | 2025-11-14 | Pointer map-key formatting | `%#v` pointer map keys now print as `(*pkg.Type)(0xaddr)` and are sorted via Go-like pointer-address tokens, with `Symbol.for('bubbletea.goPointerAddress')` overrides to keep the Vitest suite deterministic. | Final |
| D-031 | 2025-11-14 | Pointer map value literals | `%#v` map values that hold Go pointers now render as `(*pkg.Type)(0xaddr)` (or `(nil)`) even when the declared map type is `interface{}`, and `<nil>` entries no longer force type widening, keeping map output identical to Go. | Final |
| D-032 | 2025-11-14 | Channel/function & slice reference formatting | Added `GO_CHANNEL_SYMBOL` plus `goFunc`/`goChannel` helpers so `%#v` emits `(chan …)(0xaddr)` / `(func() …)(0xaddr)` and taught the formatter to print pointer literals for pointer-typed and `[]interface{}` slices, aligning Printf output with Go for channels, funcs, and pointer-valued slices. | Final |
| D-033 | 2025-11-14 | %+v formatter strategy | Introduced a dedicated `formatVerboseValue` path so `%+v` renders structs/maps/slices with Go’s field labels and no type qualifiers while reusing the pointer/channel metadata already in place for `%#v`. | Final |
| D-034 | 2025-11-14 | Pointer placeholder harness | Added a Go test-only pointer placeholder registry/normalizer so `TestPrintfFormattingVariants` can rely on real allocations (no `unsafe.Pointer(uintptr(...))`) while still asserting deterministic placeholder addresses shared with the TypeScript suite. | Final |
| D-035 | 2025-11-14 | Printf nested depth budget | Raised the TypeScript formatter’s `MAX_DETAILED_VALUE_DEPTH` to 16 so deeply nested interface maps/slices keep their Go-style pointer metadata instead of collapsing to `interface{}`. | Final |
| D-036 | 2025-11-14 | Key module scaffolding | Added `packages/tea/src/key.ts` with a Go-parity `KeyType` enum, `Key`/`KeyMsg` interfaces, and `keyToString`/`keyTypeToString` helpers (re-exported via `index.ts`) so future key parsing work targets a canonical API. | Final |
| D-037 | 2025-11-14 | Key sequence fixture generation | Added `scripts/generate-key-sequences.mjs` plus an `@bubbletea/tea/internal` export so the TypeScript specs can consume a generated copy of Go’s `sequences` table and exercise parser internals without hand-maintained data drift. | Final |
| D-038 | 2025-11-14 | readAnsiInputs contract | Defined `readAnsiInputs` as an async helper that accepts an `AbortSignal`, an (async) iterable stream of `Uint8Array` chunks, and an `emit(msg)` callback so tests can drive the reader first while keeping the eventual runtime API aligned with Node’s stream semantics. | Final |
| D-039 | 2025-11-14 | Shared key-sequence source | The generator now emits both the Vitest fixture and `packages/tea/src/internal/generated/goSequences.ts`, ensuring the runtime/parser and specs share the canonical Go sequence table with zero drift. | Final |
| D-040 | 2025-11-14 | KeyType numeric parity | TypeScript’s `KeyType` enum now reuses Go’s control-key values and negative navigation/function key block so formatter/parser logic can distinguish Ctrl/Alt keys without collisions. | Final |
| D-041 | 2025-11-14 | Program input wiring | `Program.setupInput` now routes Node streams through a cancellable async queue into `readAnsiInputs`, so runtime key/focus/mouse handling uses the same parser as the specs while AbortController-driven cleanup removes listeners without destroying caller-provided streams. | Final |
| D-042 | 2025-11-14 | SIGWINCH parity strategy | Programs listen to Node TTY `'resize'` events, emit sanitized `WindowSizeMsg` values that match Go’s `handleResize`/`checkResize`, and tear down the listener during shutdown to avoid leaking handlers. | Final |
| D-043 | 2025-11-14 | TTY raw-mode strategy | Programs now toggle Node’s `setRawMode` only when a TTY input is paired with an active renderer, capture the initial `isRaw` flag, and restore the original state during shutdown so TypeScript mirrors Go’s `tty.go` semantics without breaking custom inputs. | Final |
| D-044 | 2025-11-14 | Cancelable input reader abstraction | Added `createCancelableInputReader` as a cancellable async iterable layered on the shared ANSI input queue so future Program wiring can mirror Go’s cancelreader semantics (including InputReaderCanceledError propagation) before we add Windows-specific adapters. | Final |
| D-045 | 2025-11-14 | Windows console binding injection | Windows-specific terminal work will flow through an injectable `WindowsConsoleBinding`, enabling Vitest to drive fake bindings while production lazily loads a native/FFI shim for pseudo-console, resize, and input handling. | Final |
| D-046 | 2025-11-14 | ReleaseTerminal lifecycle parity | `Program.releaseTerminal()`/`restoreTerminal()` pause the cancelable reader without destroying stdin, capture the renderer’s alt-screen/bracketed/focus state, emit a fresh window size, and restart the renderer/input stack so suspension mirrors Go’s lifecycle. | Final |

## Pending / Future Considerations
- Terminal adapter strategy (pure Node APIs vs. `node-pty` dependency) — evaluate during Phase 1 research.
- Windows CI approach (GitHub Actions vs. other providers) — decide before Phase 4.
